<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

		<title>Particles</title>
		<!-- Import MoSync JavaScript library. -->
		<script src="js/bridge.js"></script>

		<!-- JavaScript goes here -->
		<script type="text/javascript">
		var MAX_PARTICLES = 200;
		var MIN_PARTICLES = 5;
		var PARTICLE_STEP = 5;
		var NUM_PARTICLES = MIN_PARTICLES;
		
		var numSpikes = 12;
		mShouldRender = true;

		var radiusScale = 4;

		particle = new Image();
		particle.src = 'Res/particle.png';

		startTime = new Date().getTime();
		frames = 0;
		fps = 0;
		
		//Initialize prevTime to the current time
		var prevTime = new Date().getTime();
		var totalTime = 0;
		var timeCounter = 0;
		var fps = 0;
		//A fucntion that is called for each frame to be drawn
		function timedFunc()
		{
			var currentTime = new Date().getTime();
			//Check to see if we need to add new particles
			
			if(mShouldRender)
			{
				//If the webview handles rendering, draw a frame
				draw(currentTime);
			}
			timeCounter++;
			totalTime += currentTime - prevTime;
			if(timeCounter == 100)
			{
				document.getElementById('fpsLabel').innerHTML = "FPS:" + Math.floor(10*(100000 / totalTime))/10;
				totalTime = 0;
				timeCounter = 0;
			}
			prevTime = currentTime;
		}

		function increaseParticles()
		{
			if(NUM_PARTICLES < MAX_PARTICLES)
			{
				NUM_PARTICLES += PARTICLE_STEP;
			}
			handleButtons();
			var sendParticlesMessage = new Array();
			sendParticlesMessage["messageName"] = "newParticle";
			sendParticlesMessage["AMOUNT"] = NUM_PARTICLES;
			bridge.messagehandler.send(sendParticlesMessage);
			document.getElementById('flowLabel').innerHTML = "Particles:" + NUM_PARTICLES;
		}

		function decreaseParticles()
		{
			if(NUM_PARTICLES > MIN_PARTICLES)
			{
				NUM_PARTICLES -= PARTICLE_STEP;
			}
			handleButtons();
			var sendParticlesMessage = new Array();
			sendParticlesMessage["messageName"] = "newParticle";
			sendParticlesMessage["AMOUNT"] = NUM_PARTICLES;
			bridge.messagehandler.send(sendParticlesMessage);
			document.getElementById('flowLabel').innerHTML = "Particles:" + NUM_PARTICLES;
		}
		
		var enableButtonsMessage = new Array();
		enableButtonsMessage["messageName"] = "enableButtons";

		function handleButtons()
		{
			enableButtonsMessage["add"] = "true";
			enableButtonsMessage["remove"] = "true";
			
			if(NUM_PARTICLES >= MAX_PARTICLES)
			{
				enableButtonsMessage["add"] = "false";
			}
			else if(NUM_PARTICLES <= MIN_PARTICLES)
			{
				enableButtonsMessage["remove"] = "false";
			}
			bridge.messagehandler.send(enableButtonsMessage);
		}

		function shouldRender(render) {
			mShouldRender = render;
		}
		/**
		 * Renders a particle object. The 'dots' argument
		 * should be an array of objects which have members
		 * x, y, width, height
		 **/
		function renderParticleObject(gfx, dots) {

			for(var i = 0; i < dots.length; i++) {
				var p = dots[i];
				gfx.drawImage(particle, p.x, p.y, p.width, p.height);
			}
		}


		function draw(){
			
				var canvas = document.getElementById('gfx');
			
				var gfx = canvas.getContext('2d');

				gfx.globalCompositeOperation = 'source-over';
				gfx.fillStyle = '#000';
				gfx.fillRect(0, 0, innerWidth, innerHeight);
				gfx.save(); // push state

				var d = new Date();
				var time = d.getTime();

				var twoPI = 2*Math.PI;

				gfx.globalCompositeOperation = 'lighter';

				var dots = new Array(NUM_PARTICLES)

				for(var i = 0; i < NUM_PARTICLES; i++) {
					var dot = new Object();

					var maxRamp = innerWidth/6 *Math.sin(time*0.00075);

					var ramp = maxRamp*Math.cos(-time*0.001);
					var r = innerWidth/radiusScale + ramp*Math.sin((numSpikes*i/NUM_PARTICLES)*twoPI);
					var particleSize = 80 + 70*Math.sin(time*0.004 + 4*i/NUM_PARTICLES*twoPI);

					dot.x = -particleSize/2 + innerWidth/2 + r*Math.cos(time*0.0005 + (i/NUM_PARTICLES)*twoPI);
					dot.y = -particleSize/2 + innerHeight/2 + r*Math.sin(time*0.0005 + (i/NUM_PARTICLES)*twoPI);
					dot.width = dot.height = particleSize;
					dots[i] = dot;

				}

				renderParticleObject(gfx, dots);

				gfx.fillStyle = '#fff';

				gfx.restore();
		}

		
			//Initialization
			function pageLoaded()
			{
				//Size of the rendering enviroment that fills the webview
				var innerWidth = document.documentElement.clientWidth - 10;
				var innerHeight = document.documentElement.clientHeight - 10;
				document.getElementById('flowLabel').innerHTML = "Particles:" + NUM_PARTICLES;
				//Set the canvas
				var canvas = document.getElementById('gfx');
				
				canvas.width  = innerWidth;
				canvas.height = innerHeight;
				
				//100 Frames per second for rendering
				setInterval(timedFunc, 10);
				
				handleButtons();
				
				//The initialization message
				var initOGLMessage = new Array();
				initOGLMessage["messageName"] = "initOGLVariables";
				initOGLMessage["MAX_PARTICLES"] = MAX_PARTICLES;
				initOGLMessage["AMOUNT"] = NUM_PARTICLES;
				initOGLMessage["SCREN_WIDTH"] = innerWidth;
				initOGLMessage["SCREEN_HEIGHT"] = innerHeight;
				initOGLMessage["numSpikes"] = numSpikes;
				initOGLMessage["radiusScale"] = radiusScale;

				bridge.messagehandler.send(initOGLMessage);
				
				
			}
		</script>
		
	</head>
	
	<body onload="pageLoaded()">
		<label id="fpsLabel" style="width:50%">FPS:</label>&nbsp;<label id="flowLabel" style="width:50%">Flow:</label><br>
		<canvas id="gfx"/>
	</body>
</html>